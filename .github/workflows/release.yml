name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    # 1. RÃ©cupÃ¨re le code
    - name: Checkout code
      uses: actions/checkout@v4
    
    # 2. RÃ©cupÃ¨re le numÃ©ro de version depuis le tag
    - name: Get version from tag
      id: get_version
      run: |
        $VERSION = $env:GITHUB_REF -replace 'refs/tags/v', ''
        echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
        echo "Version dÃ©tectÃ©e: $VERSION"
        
        # Convertit la version au format MSIX strict (X.X.X.X)
        $PARTS = $VERSION -split '\.'
        if ($PARTS.Count -eq 3) {
          # Format: 1.3.1 -> 1.3.1.0
          $MSIX_VERSION = "$VERSION.0"
        } elseif ($PARTS.Count -eq 4) {
          # Format: 1.3.1.1021 -> DÃ©jÃ  bon si < 65535
          $LAST = [int]$PARTS[3]
          if ($LAST -gt 65535) {
            # Prendre seulement les 4 derniers chiffres
            $PARTS[3] = $PARTS[3].Substring($PARTS[3].Length - 4)
          }
          $MSIX_VERSION = $PARTS -join '.'
        } else {
          # Fallback
          $MSIX_VERSION = "$VERSION.0.0.0"
        }
        
        echo "MSIX_VERSION=$MSIX_VERSION" >> $env:GITHUB_OUTPUT
        echo "Version MSIX: $MSIX_VERSION"
      shell: pwsh
    
    # 3. Met Ã  jour la version dans pubspec.yaml automatiquement
    - name: Update version in pubspec.yaml
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        $MSIX_VERSION = "${{ steps.get_version.outputs.MSIX_VERSION }}"
        $DATE = Get-Date -Format "yyMMdd"
        
        # Conversion MSIX au format strict X.X.X.X
        $PARTS = $MSIX_VERSION -split '\.'
        if ($PARTS.Count -eq 3) {
          # Si format 1.3.1, ajouter .0
          $MSIX_FINAL = "$MSIX_VERSION.0"
        } elseif ($PARTS.Count -eq 4) {
          # Si format 1.3.1.1021, extraire MMJJ et formater
          $MAJOR = $PARTS[0]
          $MINOR = $PARTS[1]
          $PATCH = $PARTS[2]
          $BUILD = $PARTS[3]
          # Si BUILD > 9999, prendre seulement les 4 derniers chiffres
          if ([int]$BUILD -gt 9999) {
            $BUILD = $BUILD.Substring($BUILD.Length - 4)
          }
          $MSIX_FINAL = "$MAJOR.$MINOR.$PATCH.$BUILD"
        } else {
          $MSIX_FINAL = "$VERSION.0"
        }
        
        # Mise Ã  jour version Flutter
        (Get-Content pubspec.yaml) -replace 'version: .*', "version: $VERSION+$DATE" | Set-Content pubspec.yaml
        
        # Mise Ã  jour version MSIX
        (Get-Content pubspec.yaml) -replace 'msix_version: .*', "msix_version: $MSIX_FINAL" | Set-Content pubspec.yaml
        
        echo "âœ… pubspec.yaml mis Ã  jour"
        echo "   Flutter: $VERSION+$DATE"
        echo "   MSIX: $MSIX_FINAL"
      shell: pwsh
    
    # 4. Installe Flutter
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        channel: 'stable'
    
    # 5. Installe les dÃ©pendances
    - name: Install dependencies
      run: flutter pub get
    
    # 6. Build Windows en Release
    - name: Build Windows Release
      run: flutter build windows --release
    
    # 7. CrÃ©e le package MSIX (DÃ‰SACTIVÃ‰ TEMPORAIREMENT)
    # - name: Create MSIX Package
    #   run: |
    #     echo "ğŸ”¨ CrÃ©ation du package MSIX..."
    #     flutter pub run msix:create
    #     
    #     # VÃ©rifie que le MSIX a Ã©tÃ© crÃ©Ã©
    #     if (Test-Path "build/windows/x64/runner/Release/*.msix") {
    #       echo "âœ… Package MSIX crÃ©Ã© avec succÃ¨s"
    #       Get-ChildItem build/windows/x64/runner/Release/*.msix
    #     } else {
    #       echo "âŒ Erreur: Package MSIX non trouvÃ©"
    #       exit 1
    #     }
    #   shell: pwsh
    
    # 8. Renomme le MSIX avec la version (DÃ‰SACTIVÃ‰ TEMPORAIREMENT)
    # - name: Rename MSIX with version
    #   run: |
    #     $VERSION = "${{ steps.get_version.outputs.VERSION }}"
    #     $MSIX_FILE = Get-ChildItem -Path "build/windows/x64/runner/Release/*.msix" | Select-Object -First 1
    #     
    #     if ($MSIX_FILE) {
    #       $NEW_NAME = "XRTechTools-Windows-v$VERSION.msix"
    #       Copy-Item $MSIX_FILE.FullName -Destination $NEW_NAME
    #       echo "âœ… MSIX renommÃ©: $NEW_NAME"
    #       echo "Taille: $([math]::Round($MSIX_FILE.Length / 1MB, 2)) MB"
    #     } else {
    #       echo "âŒ Fichier MSIX non trouvÃ©"
    #       exit 1
    #     }
    #   shell: pwsh
    
    # 9. CrÃ©e aussi un ZIP portable (optionnel)
    - name: Create Portable ZIP
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        cd build/windows/x64/runner/Release
        
        # Exclut le MSIX du ZIP
        $FILES = Get-ChildItem -Exclude "*.msix"
        Compress-Archive -Path $FILES -DestinationPath "../../../../../XRTechTools-Windows-Portable-v$VERSION.zip"
        
        echo "âœ… Version portable crÃ©Ã©e: XRTechTools-Windows-Portable-v$VERSION.zip"
      shell: pwsh
    
    # 10. Build Android APK
    - name: Build Android APK
      run: flutter build apk --release
    
    # 11. Renomme l'APK avec la version
    - name: Rename APK with version
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        Copy-Item build/app/outputs/flutter-apk/app-release.apk -Destination "XRTechTools-Android-v$VERSION.apk"
        echo "âœ… APK crÃ©Ã©: XRTechTools-Android-v$VERSION.apk"
      shell: pwsh
    
    # 12. Calcule les checksums (sÃ©curitÃ©)
    - name: Generate checksums
      run: |
        $VERSION = "${{ steps.get_version.outputs.VERSION }}"
        
        echo "# XR Tech Tools v$VERSION - Checksums SHA256" > checksums.txt
        echo "" >> checksums.txt
        
        # MSIX TEMPORAIREMENT DÃ‰SACTIVÃ‰
        # $MSIX_HASH = (Get-FileHash "XRTechTools-Windows-v$VERSION.msix" -Algorithm SHA256).Hash
        # echo "## Windows MSIX" >> checksums.txt
        # echo "``````" >> checksums.txt
        # echo "$MSIX_HASH  XRTechTools-Windows-v$VERSION.msix" >> checksums.txt
        # echo "``````" >> checksums.txt
        # echo "" >> checksums.txt
        
        # ZIP Portable
        $ZIP_HASH = (Get-FileHash "XRTechTools-Windows-Portable-v$VERSION.zip" -Algorithm SHA256).Hash
        echo "## Windows Portable (ZIP)" >> checksums.txt
        echo "``````" >> checksums.txt
        echo "$ZIP_HASH  XRTechTools-Windows-Portable-v$VERSION.zip" >> checksums.txt
        echo "``````" >> checksums.txt
        echo "" >> checksums.txt
        
        # APK
        $APK_HASH = (Get-FileHash "XRTechTools-Android-v$VERSION.apk" -Algorithm SHA256).Hash
        echo "## Android APK" >> checksums.txt
        echo "``````" >> checksums.txt
        echo "$APK_HASH  XRTechTools-Android-v$VERSION.apk" >> checksums.txt
        echo "``````" >> checksums.txt
        
        echo "âœ… Checksums gÃ©nÃ©rÃ©s (MSIX temporairement dÃ©sactivÃ©)"
        Get-Content checksums.txt
      shell: pwsh
    
    # 13. CrÃ©e la Release GitHub
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          XRTechTools-Windows-Portable-v${{ steps.get_version.outputs.VERSION }}.zip
          XRTechTools-Android-v${{ steps.get_version.outputs.VERSION }}.apk
          checksums.txt
        body: |
          ## ğŸ“¦ XR Tech Tools v${{ steps.get_version.outputs.VERSION }}
          
          **Application d'entraÃ®nement et de pratique professionnelle pour techniciens informatique**
          
          ---
          
          ### ğŸªŸ Windows
          
          #### Version Portable (ZIP) - RECOMMANDÃ‰ TEMPORAIREMENT
          ğŸ“¥ **`XRTechTools-Windows-Portable-v${{ steps.get_version.outputs.VERSION }}.zip`**
          
          **Installation :**
          1. Extraire le fichier ZIP
          2. Lancer `xrtechtools.exe`
          3. Aucune installation requise
          
          **Avantages :**
          - âœ… Aucune installation requise
          - âœ… Portable et lÃ©ger
          - âœ… Fonctionne sur toutes les versions Windows
          
          ---
          
          ### ğŸ“± Android
          
          ğŸ“¥ **`XRTechTools-Android-v${{ steps.get_version.outputs.VERSION }}.apk`**
          
          **Installation :**
          1. Activez "Sources inconnues" dans les paramÃ¨tres de sÃ©curitÃ©
          2. Ouvrez le fichier APK tÃ©lÃ©chargÃ©
          3. Suivez les instructions d'installation
          
          ---
          
          ### ğŸ”’ VÃ©rification de l'intÃ©gritÃ©
          
          Pour vÃ©rifier que vos fichiers tÃ©lÃ©chargÃ©s n'ont pas Ã©tÃ© altÃ©rÃ©s, comparez les checksums SHA256 avec ceux du fichier `checksums.txt` inclus dans cette release.
          
          **Windows (PowerShell) :**
          ```powershell
          Get-FileHash "XRTechTools-Windows-Portable-v${{ steps.get_version.outputs.VERSION }}.zip" -Algorithm SHA256
          ```
          
          **Linux/macOS :**
          ```bash
          sha256sum XRTechTools-Windows-Portable-v${{ steps.get_version.outputs.VERSION }}.zip
          ```
          
          ---
          
          ### ğŸ“ Changements
          
          Consultez le [CHANGELOG.md](https://github.com/WolwX/xr-tech-tools/blob/main/CHANGELOG.md) pour la liste complÃ¨te des modifications.
          
          ---
          
          ### ğŸ› Signaler un problÃ¨me
          
          Si vous rencontrez un bug, ouvrez une [issue sur GitHub](https://github.com/WolwX/xr-tech-tools/issues).
          
          ---
          
          ### âš ï¸ Note importante
          
          **Le package MSIX Windows est temporairement dÃ©sactivÃ©** en raison de problÃ¨mes de compatibilitÃ© avec le nouveau nom d'application. Utilisez la version ZIP portable pour Windows.
          
          ---
          
          **DÃ©veloppÃ© par Xavier Redondo avec l'assistance de Claude (Anthropic)**
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # 14. Notification de succÃ¨s
    - name: Build Summary
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âœ… BUILD TERMINÃ‰ AVEC SUCCÃˆS"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸ“¦ Fichiers crÃ©Ã©s:"
        echo "   â€¢ ZIP Windows (portable) - MSIX temporairement dÃ©sactivÃ©"
        echo "   â€¢ APK Android"
        echo "   â€¢ Checksums SHA256"
        echo ""
        echo "ğŸ”— Release disponible sur:"
        echo "   https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      shell: pwsh